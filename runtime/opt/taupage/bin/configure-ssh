#!/usr/bin/env python3

import yaml

with open('/meta/taupage.yaml') as fd:
    config = yaml.safe_load(fd)

ssh_ports = config.get('ssh_ports', [22])

lines = []

ports_added = False

with open('/etc/ssh/sshd_config') as fd:
    for line in fd:
        if line.strip().startswith('Port '):
            if not ports_added:
                for port in ssh_ports:
                    lines.append('Port {} # generated by configure-ssh\n'.format(port))
                ports_added = True
        else:
            lines.append(line)

if config.get('ssh_gateway_ports'):
    lines.append('GatewayPorts {} # generated by configure-ssh\n'.format(config.get('ssh_gateway_ports')))

with open('/etc/ssh/sshd_config', 'w') as fd:
    fd.writelines(lines)
